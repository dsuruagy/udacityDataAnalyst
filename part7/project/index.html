<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <script src="https://d3js.org/d3.v4.min.js"></script>
    <style>
      .line {
        fill: none;
        stroke-width: 2px;
      }
    </style>
    <script type="text/javascript">
    	function draw(data) {
	        "use strict";
	        var margin = 75,
	            width = 1400 - margin,
	            height = 600 - margin;

	        var svg = d3.select("body")
	            .append("svg")
	            .attr("width", width + margin)
	            .attr("height", height + margin)
	            .append('g')
	            .attr('class', 'chart');

          var minDelay = 0, maxDelay = 0;
          var months = ['Jan','Feb','Mar','Apr','May','Jun',
                        'Jul','Aug','Sep','Oct','Nov','Dec'];

          // aggregate data by month and departure hour
          var nested = d3.nest()
            .key(function(d) { return d.Month})
            .key(function(d) { return d.depInterval})
            .rollup(function(leaves) {
              // sum the delays for the aggregation
              var sumDelays = d3.sum(leaves, function(d) { return d.meanDelay});
              minDelay = Math.min(minDelay, sumDelays);
              maxDelay = Math.max(maxDelay, sumDelays);
              return sumDelays;
            })
            .entries(data);

          // https://stackoverflow.com/questions/23558701/d3-js-line-chart-with-time-on-both-axis
          var xMin = d3.min(data, function(d) {
            return d.depInterval;
          });

          var xMax = d3.max(data, function(d) {
            return d.depInterval;
          });

          var scaleInterval = d3.scaleTime()
          .range([margin, width])
          .domain([xMin, xMax]);

    			var scaleDelay = d3.scaleLinear()
                	.range([height, margin])
                	.domain([minDelay, maxDelay]);

          function getMonth(id) {
            return months[id - 1];
          }

          var colorScale = d3.scaleOrdinal(d3.schemeCategory20).domain([1,12]);

          var timeAxis = d3.axisBottom(scaleInterval)
            .ticks(24)
            .tickFormat(d3.timeFormat("%H:%M"));

    			var delayAxis = d3.axisLeft(scaleDelay);

    			svg.append('g')
    			.attr('class', 'x axis')
    			.attr('transform', "translate(0," + height + ")")
    			.call(timeAxis);

    			svg.append('g')
    			.attr('class', 'y axis')
    			.attr('transform', "translate(" + margin + ",0)")
    			.call(delayAxis);

          // specify what will be shown in the lines
          // http://bl.ocks.org/d3noob/d8be922a10cb0b148cd5
          var line = d3.line()
            .x(function(d) {
              // d['key'] is the hour
              return scaleInterval(d3.isoParse(d.key));
            })
            .y(function(d) {
              // d['value'] is the delay value
              return scaleDelay(d.value);
            });

          // for each month in nested data, add a line for its values (hour and
          // delay)
          nested.forEach(function(d){
            // debugger;
            svg.append("path")
              .attr("class", "line")
              .attr("id", getMonth(d.key))
              .attr("d", line(d.values))
              .style("stroke", colorScale(d.key))
              .style("opacity",0.2);

            svg.selectAll('path')
              .on("mouseover", function(d) {

                d3.select(this)
                  .transition()
                  .duration(250)
                  .style('stroke-width', '6px')
                  .style("opacity", 1);

                d3.select("#leg_" + this.id)
                  .transition()
                  .duration(250)
                  .style("font-weight", "bold");
                // debugger;

              })
              .on("mouseout", function(d) {
                d3.select(this)
                  .transition()
                  .duration(250)
                  .style('stroke-width', '3px')
                  .style("opacity",0.2);

                d3.selectAll('.legend')
                  .transition()
                  .duration(250)
                  .selectAll('g')
                  .style("font-weight", "normal");
              });
          });

          var legend = svg.append("g")
            .attr("class", "legend")
            .attr("transform", "translate(" + (width - 100) + "," + 20 + ")")
            .selectAll("g")
            .data(months)
            .enter().append("g")
            .attr("id", function(d) {
              return "leg_" + d;
            });

          legend.append("circle")
            .attr("cy", function(d, i) {
              return i * 30;
            })
            .attr("r", 5)
            .attr("fill", function(d, i) {
              return colorScale(i+1)
            });

          legend.append("text")
            .attr("y", function(d, i) {
              return i * 30 + 5;
            })
            .attr("x", 3 * 5)

            .text(function(d) {
              return d;
            });
     }
    </script>
  </head>
<body>
  <script type="text/javascript">
  	var parseHour = d3.timeParse("%H:%M");

    d3.csv("2008-mean.csv", function(d) {
      d['depInterval'] = parseHour(d['depInterval']);
      d['meanDelay'] = +d['meanDelay'];

      return d;
    }, draw);
  </script>
</body>
</html>
